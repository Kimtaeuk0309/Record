<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>개인 상세 기록</title>
    <style>
        table { border-collapse: collapse; width: 90%; max-width: 900px; margin: 20px auto; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        h1, h2 { text-align: center; }
        .total-row { font-weight: bold; background-color: #e0e0e0; }
        #totalCountDisplay { text-align: center; font-weight: bold; margin-top: 20px; }
        #rankChart { max-width: 300px; margin: 20px auto; display: block; }
    </style>
</head>
<body>
<h1 id="nicknameTitle">개인 기록</h1>

<div id="totalCountDisplay">총국수: -</div>
<canvas id="rankChart"></canvas>

<div>
    <h2 style="text-align:center; margin-top: 40px;">자리별 기록 통계</h2>
    <table style="margin: 0 auto; width: 90%; max-width: 900px;">
        <thead>
        <tr>
            <th>자리</th>
            <th>출전 횟수</th>
            <th>1위 횟수</th>
            <th>2위 횟수</th>
            <th>3위 횟수</th>
            <th>4위 횟수</th>
            <th>1위 비율</th>
            <th>2위 비율</th>
            <th>3위 비율</th>
            <th>4위 비율</th>
        </tr>
        </thead>
        <tbody id="positionStatsBody"></tbody>
    </table>
</div>

<!-- 역만 기록 리스트 출력 영역 -->
<div style="max-width: 900px; margin: 20px auto;">
    <h2 style="text-align: center; margin-top: 40px;">역만 기록 목록</h2>
    <ul id="yakuListContainer" style="font-size: 0.9em; line-height: 1.4em; padding-left: 20px;"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function loadDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const nickname = urlParams.get("nickname");
        if (!nickname) {
            alert("닉네임이 지정되지 않았습니다.");
            return;
        }
        document.getElementById("nicknameTitle").textContent = `${nickname}님의 상세 기록`;

        let totalCount = 0;
        try {
            const statsResp = await fetch('/api/statistics');
            if (!statsResp.ok) throw new Error('통계 데이터 불러오기 실패: ' + statsResp.status);
            const statsList = await statsResp.json();
            const stat = statsList.find(s => s.nickname === nickname);
            totalCount = stat ? stat.totalCount : 0;
        } catch (e) {
            alert('총국수 조회 중 오류가 발생했습니다.');
            console.error(e);
            totalCount = 0;
        }
        document.getElementById("totalCountDisplay").textContent = `총국수: ${totalCount}`;

        let resJson = null;
        let records = [];
        try {
            const detailResp = await fetch(`/api/recordset/detail?nickname=${encodeURIComponent(nickname)}`);
            if (!detailResp.ok) {
                alert("상세 기록 조회 실패");
                return;
            }
            resJson = await detailResp.json();
            records = Array.isArray(resJson) ? resJson : (resJson.records || []);
        } catch (e) {
            alert("상세 기록 조회 중 오류가 발생했습니다.");
            console.error(e);
            return;
        }

        if (!Array.isArray(records)) {
            alert("상세 기록 데이터가 배열이 아닙니다.");
            return;
        }

        const positionStats = {
            "동": { count: 0, ranks: [0, 0, 0, 0] },
            "남": { count: 0, ranks: [0, 0, 0, 0] },
            "서": { count: 0, ranks: [0, 0, 0, 0] },
            "북": { count: 0, ranks: [0, 0, 0, 0] }
        };

        records.forEach(rec => {
            if (!rec) return;
            if (rec.nickname === nickname && rec.direction && positionStats.hasOwnProperty(rec.direction)) {
                positionStats[rec.direction].count++;
                if (typeof rec.rank === "number" && rec.rank >= 1 && rec.rank <= 4) {
                    positionStats[rec.direction].ranks[rec.rank - 1]++;
                }
            }
        });

        const posStatsBody = document.getElementById("positionStatsBody");
        posStatsBody.innerHTML = "";

        for (const pos of ["동", "남", "서", "북"]) {
            const stat = positionStats[pos];
            stat.count = stat.ranks.reduce((a, b) => a + b, 0);
        }

        const totalRanks = [0, 0, 0, 0];
        let totalPositionsCount = 0;
        Object.values(positionStats).forEach(stat => {
            totalPositionsCount += stat.count;
            for (let i = 0; i < 4; i++) {
                totalRanks[i] += stat.ranks[i];
            }
        });

        const rankPercentages = totalPositionsCount ? totalRanks.map(r => (r / totalPositionsCount) * 100) : [0, 0, 0, 0];
        const ctx = document.getElementById('rankChart').getContext('2d');
        if (window.rankChartInstance) {
            window.rankChartInstance.destroy();
        }
        window.rankChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['1위', '2위', '3위', '4위'],
                datasets: [{
                    data: rankPercentages,
                    backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336'],
                    hoverOffset: 30,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(1)}%`
                        }
                    }
                }
            }
        });

        // 합계 행 추가
        const totalTr = document.createElement("tr");
        totalTr.classList.add("total-row");
        totalTr.innerHTML = `
            <td>합계</td>
            <td>${totalPositionsCount}</td>
            <td>${totalRanks[0]}</td>
            <td>${totalRanks[1]}</td>
            <td>${totalRanks[2]}</td>
            <td>${totalRanks[3]}</td>
            <td>${totalPositionsCount ? ((totalRanks[0]/totalPositionsCount)*100).toFixed(1) : '0.0'}%</td>
            <td>${totalPositionsCount ? ((totalRanks[1]/totalPositionsCount)*100).toFixed(1) : '0.0'}%</td>
            <td>${totalPositionsCount ? ((totalRanks[2]/totalPositionsCount)*100).toFixed(1) : '0.0'}%</td>
            <td>${totalPositionsCount ? ((totalRanks[3]/totalPositionsCount)*100).toFixed(1) : '0.0'}%</td>
        `;
        posStatsBody.appendChild(totalTr);

        for (const pos of ["동", "남", "서", "북"]) {
            const stat = positionStats[pos];
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${pos}</td>
                <td>${stat.count}</td>
                <td>${stat.ranks[0]}</td>
                <td>${stat.ranks[1]}</td>
                <td>${stat.ranks[2]}</td>
                <td>${stat.ranks[3]}</td>
                <td>${stat.count ? ((stat.ranks[0]/stat.count)*100).toFixed(1) : '0.0'}%</td>
                <td>${stat.count ? ((stat.ranks[1]/stat.count)*100).toFixed(1) : '0.0'}%</td>
                <td>${stat.count ? ((stat.ranks[2]/stat.count)*100).toFixed(1) : '0.0'}%</td>
                <td>${stat.count ? ((stat.ranks[3]/stat.count)*100).toFixed(1) : '0.0'}%</td>
            `;
            posStatsBody.appendChild(tr);
        }

        // --- 역만 기록 목록 출력 ---

        const yakuListContainer = document.getElementById("yakuListContainer");
        yakuListContainer.innerHTML = '';

        const yakuEntries = [];
        const globalTimestamp = (resJson && resJson.timestamp) ? resJson.timestamp.substring(0, 10) : '날짜 없음';

        records.forEach(rec => {
            if (!rec) return;
            if (rec.nickname === nickname && Array.isArray(rec.yakuList) && rec.yakuList.length > 0) {
                // 개별 record.timestamp가 없으면 전체 RecordSet timestamp 사용
                const dateStr = (rec.timestamp && rec.timestamp.length >= 10) ? rec.timestamp.substring(0, 10) : globalTimestamp;

                rec.yakuList.forEach(yaku => {
                    yakuEntries.push({ date: dateStr, yaku });
                });
            }
        });

        // 날짜 오름차순 정렬
        yakuEntries.sort((a, b) => a.date.localeCompare(b.date));

        if (yakuEntries.length === 0) {
            yakuListContainer.textContent = '역만 기록이 없습니다.';
        } else {
            yakuEntries.forEach(entry => {
                const li = document.createElement("li");
                li.textContent = `${entry.date} / ${entry.yaku}`;
                yakuListContainer.appendChild(li);
            });
        }
    }

    window.onload = loadDetail;
</script>

</body>
</html>
