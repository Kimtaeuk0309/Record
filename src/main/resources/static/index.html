<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>벽뿌방 기록시스템</title>
    <style>
        table { border-collapse: collapse; width: 100%; max-width: 950px; margin-top: 30px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        #btnContainer { margin-top: 10px; display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 18px; font-size: 1em; cursor: pointer; }
        h1 { margin-bottom: 15px; }
        a.detail-link { color: #1a73e8; text-decoration: underline; cursor: pointer; }
        a.detail-link:hover { color: #0e4da4; }
        #loginForm {
            margin-top: 20px;
            max-width: 240px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #loginForm input {
            height: 28px;
            font-size: 0.9em;
            padding: 0 6px;
            box-sizing: border-box;
        }
        #userId, #userPw {
            width: 80px;
        }
        #loginBtn {
            padding: 5px 5px;
            font-size: 0.9em;
            cursor: pointer;
        }
        #loginMessage {
            color: red;
            margin-top: 10px;
            font-weight: bold;
        }
        footer {
            margin-top: 40px;
            padding: 20px 0;
            text-align: center;
            background-color: #f9f9f9;
            font-size: 0.9em;
            color: #555;
        }
        footer a {
            color: #1DA1F2;
            text-decoration: none;
            margin-left: 8px;
            font-size: 1.2em;
        }
        footer a:hover {
            color: #0d95e8;
        }
    </style>
    <!-- Font Awesome CDN for Twitter icon -->
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>
<body>
<h1>벽뿌방 기록시스템</h1>

<!-- 로그인 폼 -->
<div id="loginForm">
    <input type="text" id="userId" name="userId" placeholder="ID" autocomplete="username" />
    <input type="password" id="userPw" name="userPw" placeholder="PW" autocomplete="current-password" />
    <button type="button" id="loginBtn">로그인</button>
</div>

<!-- 로그인 후 버튼들을 감싸는 영역 -->
<div id="btnContainer" style="display:none;">
    <a href="addmember.html">
        <button type="button">멤버 등록</button>
    </a>
    <a href="addRecord.html">
        <button type="button">기록 입력</button>
    </a>
    <a href="recordList.html">
        <button type="button">전체 기록 조회</button>
    </a>
    <button type="button" id="logoutBtn">로그아웃</button>
</div>

<!-- 항상 보이는 기간별 기록 조회 버튼 -->
<div id="alwaysVisibleBtnContainer" style="margin-top: 10px;">
    <a href="periodList.html">
        <button type="button">기간별 기록 조회</button>
    </a>
</div>

<!-- 로그인 필요 메시지 -->
<div id="loginMessage" style="display:none;">
    로그인 후 기록 입력이 가능합니다.
</div>

<h2 style="margin-top:30px;">전체 기록</h2>
<table id="statsTable">
    <thead>
    <tr>
        <th>닉네임</th>
        <th>총승점</th>
        <th>평균승점</th>
        <th>1위횟수 (1위율)</th>
        <th>2위횟수 (2위율)</th>
        <th>3위횟수 (3위율)</th>
        <th>4위횟수 (4위율)</th>
        <th>총국수</th>
    </tr>
    </thead>
    <tbody>
    <!-- 데이터 자동 삽입 -->
    </tbody>
</table>

<script src="js/common.js"></script>
<script>
    // JWT 파싱 유틸리티
    function parseJwt(token) {
        try {
            const payload = token.split('.')[1];
            const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
            return JSON.parse(decoded);
        } catch (e) {
            return null;
        }
    }

    // 자동 로그아웃 타이머 관리용 변수
    let logoutTimerId = null;

    // 자동 로그아웃 예약 함수
    function scheduleAutoLogout(token) {
        // 기존 타이머 제거
        if (logoutTimerId) {
            clearTimeout(logoutTimerId);
            logoutTimerId = null;
        }
        if (!token) return;

        const jwt = parseJwt(token);
        if (jwt && jwt.exp) {
            const nowSec = Math.floor(Date.now() / 1000);
            const expiresInSec = jwt.exp - nowSec;
            localStorage.setItem('tokenExpiresAt', jwt.exp);
            if (expiresInSec > 0) {
                logoutTimerId = setTimeout(() => {
                    alert('세션이 만료되어 자동 로그아웃 됩니다.');
                    logoutAndUI();
                }, expiresInSec * 1000);
            } else {
                logoutAndUI();
            }
        }
    }

    // 로그아웃 함수 + UI
    function logoutAndUI() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('loginUserId');
        localStorage.removeItem('tokenExpiresAt');
        if (logoutTimerId) clearTimeout(logoutTimerId);
        logoutTimerId = null;
        initializeUIForLoggedOut();
    }

    document.getElementById('loginBtn').addEventListener('click', async function () {
        const userId = document.getElementById('userId').value.trim();
        const userPw = document.getElementById('userPw').value.trim();

        if (!userId || !userPw) {
            alert('아이디와 비밀번호를 모두 입력해주세요.');
            return;
        }

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: userId, password: userPw })
            });

            if (!response.ok) {
                alert('로그인 실패: 아이디 또는 비밀번호가 올바르지 않습니다.');
                return;
            }

            const data = await response.json();
            const token = data.token;
            const username = data.username || userId;

            localStorage.setItem('authToken', token);
            localStorage.setItem('loginUserId', username);

            scheduleAutoLogout(token);

            initializeUIForLoggedIn();

        } catch (error) {
            alert('로그인 중 오류가 발생했습니다: ' + error.message);
        }
    });

    // 로그아웃 버튼 클릭 처리
    document.getElementById('logoutBtn').addEventListener('click', function () {
        logoutAndUI();
    });

    // 로그인된 UI 상태로 변경
    function initializeUIForLoggedIn() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('btnContainer').style.display = 'flex';
        document.getElementById('loginMessage').style.display = 'none';
    }

    // 로그아웃 또는 미로그인 상태 UI
    function initializeUIForLoggedOut() {
        document.getElementById('loginForm').style.display = 'flex';
        document.getElementById('btnContainer').style.display = 'none';
        document.getElementById('loginMessage').style.display = 'block';
    }

    // 페이지 로드시 로그인 상태 및 토큰 만료 체크
    window.onload = function () {
        const token = localStorage.getItem('authToken');
        const expiresAt = Number(localStorage.getItem('tokenExpiresAt') || 0);
        const nowSec = Math.floor(Date.now() / 1000);

        if (token && expiresAt) {
            if (expiresAt > nowSec) {
                scheduleAutoLogout(token);
                initializeUIForLoggedIn();
            } else {
                logoutAndUI();
            }
        } else if (token) {
            // 만약 만료정보 없으면 단순 로그인 유지(이전 코드 호환)
            initializeUIForLoggedIn();
        } else {
            initializeUIForLoggedOut();
        }
        loadStatistics();
    };

    // 전체 기록 데이터 불러오기 및 닉네임 클릭 시 상세 페이지 이동 링크 포함
    async function loadStatistics() {
        try {
            const response = await fetch('/api/statistics');
            if (!response.ok) throw new Error('통계 데이터 불러오기 실패: ' + response.status);

            let stats = await response.json();
            stats.sort((a, b) => b.totalPoints - a.totalPoints);

            const tbody = document.querySelector('#statsTable tbody');
            tbody.innerHTML = '';

            stats.forEach(stat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <a href="detail.html?nickname=${encodeURIComponent(stat.nickname)}"
                           class="detail-link"
                           title="${stat.nickname}의 상세 기록 보기">
                            ${stat.nickname}
                        </a>
                    </td>
                    <td>${stat.totalPoints.toFixed(1)}</td>
                    <td>${stat.avgPoints.toFixed(1)}</td>
                    <td>${stat.firstPlaceCount} (${(stat.firstPlaceRate * 100).toFixed(1)}%)</td>
                    <td>${stat.secondPlaceCount} (${(stat.secondPlaceRate * 100).toFixed(1)}%)</td>
                    <td>${stat.thirdPlaceCount} (${(stat.thirdPlaceRate * 100).toFixed(1)}%)</td>
                    <td>${stat.fourthPlaceCount} (${(stat.fourthPlaceRate * 100).toFixed(1)}%)</td>
                    <td>${stat.totalCount}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            alert(error.message);
        }
    }
</script>

<footer>
    Copyright &copy; Cudo
    <a href="https://twitter.com/Cudo3399" target="_blank" rel="noopener noreferrer" aria-label="Twitter @Cudo3399">
        <i class="fab fa-twitter" aria-hidden="true"></i>
    </a>
</footer>

<!-- Font Awesome CDN for Twitter icon -->
<link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</body>
</html>
